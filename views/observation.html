<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet/less" href="../less/observation.less" />
		<script src="../lib/less/less.min.js"></script>
	</head>
	
	<body>
		<script src="../js/mui.min.js"></script>
		<div class="obervationBox">
			<!--头部-->
			<header class="mui-bar mui-bar-nav">
		        <h1 class="mui-title"><span id='titleId'></span><span class="mui-icon mui-icon-arrowdown title_icon"id='patientDown'></span></h1> 
		        <div class="leftBack">
		        	<a class="text"href="../index.html">床位概览</a>
		        </div>		        	
	    	</header>
	    	
	    	<div class="dataTime">
	    		<span id="currentDate"></span>
	    		<span class="time">
	    			<span><i class="one"></i></span>
	    			<span class="now"><input type="time"value="12:45" /><i class="two"></i></span>
	    			<span><i class="three"></i></span>
	    		</span>
	    	</div>
	    		<div class="listcontainer">
	    		<div class="temperature">
		    		<ul>
		    			<li><span>体温</span><input type="text"  class="testName"name='Temperature'/><span class="unit">℃</span></li>
		    			<li><span>箱温</span><input type="text" class="testName" name='Incubator'/><span class="unit">℃</span></li>
		    			<li><span>湿度</span><input type="text" class="testName" name='Humidity'/><span class="unit">℃</span></li>
		    		</ul>
	    		</div>
	    		<div class="blood">
		    		<ul>
		    			<li>
		    				<span>血氧位置</span>
		    				<select name="BloodOxygen" id="OxygenDom">
		    					<option value="">请选择</option>
		    				</select>
		    			</li>
		    			<li>
		    				<span>面色/脂端</span>
		    				<select name="Face" id="faceDom">
		    					<option value="">请选择</option>
		    				</select>
		    			</li>
		    			<li>
		    				<span>皮肤</span>
		    				<select name="Skin" id="skinDom">
		    					<option value="">请选择</option>
		    				</select>
		    			</li>
		    			<li>
		    				<span>肌张力</span>
		    				<select name="MuscularTension" id="muscleDom">
		    					<option value="">请选择</option>
		    				</select>
		    			</li>
		    			<li>
		    				<span>腹部</span>
		    				<select name="Abdomen" id="stomachDom">
		    					<option value="">请选择</option>
		    				</select>
		    			</li>
		    			<li>
		    				<span>体位</span>
		    				<select name="BodyPosition" id="bodyDom">
		    					<option value="">请选择</option>
		    				</select>
		    			</li>
		    			<li>
		    				<span>氧疗方式</span>		    				
		    				<select name="OxygenTherapy" id="oxygenTherapyDom">
		    					<option value="">请选择</option>
		    				</select>
		    			</li>
		    			<li><span>FiO2</span><input type="text" name='FiO2'/></li>
		    			<li>
		    				<span>口鼻腔分泌物</span>
		    				<select name="Oronasal" id="SecretionDom">
		    					<option value="">请选择</option>
		    				</select>
		    			</li>
		    		</ul>
	    		</div>
	    		<div class="weight">
		    		<ul>
		    			<li>
		    				<span>模式</span>
		    				<select name="Model" id="modelDom">
		    					<option value="">请选择</option>
		    				</select>
		    			</li>
		    			<li><span>频率</span><input type="text"name='FQCY' /></li>
		    			<li>
		    				<span>PIP/PEEP</span>
		    				<select name="PiP" id="PIPDom">
		    					<option value="">请选择</option>
		    				</select>
		    			</li>
		    			<li>
		    				<span>气管里分泌物</span>
		    				<select name="AirPipe" id="tracheaDom">
		    					<option value="">请选择</option>
		    				</select>
		    			</li>
		    			<li><span>体重</span><input type="text"name='Weight' /></li>
		    		</ul>
	    		</div>
	    		<button class="save"id='saveBtn'>保存并上传</button>
	    	</div>	    		
	    	<!--底部导航-->
	    	<nav class="mui-bar mui-bar-tab footer">
      			<a id="defaultTab" class="mui-tab-item mui-active active" href="javascript:;">
                	<span class="mui-icon oberItem"></span>
                	<span class="mui-tab-label">观察项</span>
       			</a>
      			<a class="mui-tab-item" href="javascript:;">
                	<span class="mui-icon bedOper"></span>
                	<span class="mui-tab-label">床旁操作</span>
       			</a>
      			<a class="mui-tab-item" href="javascript:;"id='jumpOut'>
                	<span class="mui-icon out"></span>
                	<span class="mui-tab-label">出量</span>
      			</a>  
      			<a class="mui-tab-item" href="javascript:;">
                	<span class="mui-icon in"></span>
                	<span class="mui-tab-label">入量</span>
      			</a>  
      			<a class="mui-tab-item" href="javascript:;"id='jumpLife'>
                	<span class="mui-icon life"></span>
                	<span class="mui-tab-label">生命体征</span>
      			</a>  
    		</nav>
			
		</div>
		<script src="../lib/template/template.js"></script>
		<script type='text/template'id='OxygenTpl'>
			<option value="">请选择</option>
			{{each Oxygen as value i}}
		    	<option value="{{value}}">{{value}}</option>
		    {{/each}}
		</script>
		<script type='text/template'id='faceTpl'>
			<option value="">请选择</option>
			{{each face as value i}}
		    	<option value="{{value}}">{{value}}</option>
		    {{/each}}
		</script>
		<script type='text/template'id='skinTpl'>
			<option value="">请选择</option>
			{{each skin as value i}}
		    	<option value="{{value}}">{{value}}</option>
		    {{/each}}
		</script>
		<script type='text/template'id='muscleTpl'>
			<option value="">请选择</option>
			{{each muscle as value i}}
		    	<option value="{{value}}">{{value}}</option>
		    {{/each}}
		</script>
		<script type='text/template'id='stomachTpl'>
			<option value="">请选择</option>
			{{each stomach as value i}}
		    	<option value="{{value}}">{{value}}</option>
		    {{/each}}
		</script>
		<script type='text/template'id='bodyTpl'>
			<option value="">请选择</option>
			{{each body as value i}}
		    	<option value="{{value}}">{{value}}</option>
		    {{/each}}
		</script>
		<script type='text/template'id='oxygenTherapyTpl'>
			<option value="">请选择</option>
			{{each oxygenTherapy as value i}}
		    	<option value="{{value}}">{{value}}</option>
		    {{/each}}
		</script>
		<script type='text/template'id='SecretionTpl'>
			<option value="">请选择</option>
			{{each Secretion as value i}}
		    	<option value="{{value}}">{{value}}</option>
		    {{/each}}
		</script>
		<script type='text/template'id='modelTpl'>
			<option value="">请选择</option>
			{{each model as value i}}
		    	<option value="{{value}}">{{value}}</option>
		    {{/each}}
		</script>
		<script type='text/template'id='PIPTpl'>
			<option value="">请选择</option>
			{{each PIP as value i}}
		    	<option value="{{value}}">{{value}}</option>
		    {{/each}}
		</script>
		<script type='text/template'id='tracheaTpl'>
			<option value="">请选择</option>
			{{each trachea as value i}}
		    	<option value="{{value}}">{{value}}</option>
		    {{/each}}
		</script>
		<script src="../js/public.js"></script>
		<script>
			var MRN=GetRequest(location.search).MRN;
			var patientName=unescape(GetRequest(location.search).PatientName);
			var patientNumber=GetRequest(location.search).PatientNumber;
			document.getElementById('titleId').innerHTML=patientName;
			var inputs=document.getElementsByTagName('input');
			for(var i=0;i<inputs.length;i++){
				inputs[i].setAttribute('placeholder','请输入');
			}
		</script>
		<!--时间控件-->
		<script>
			var selectors=document.getElementsByTagName('select');
			document.getElementById('currentDate').innerHTML=new Date().Format("yyyy-MM-dd");
			document.getElementsByClassName('listcontainer')[0].classList.remove('hasSave');
			document.getElementsByClassName('listcontainer')[0].classList.remove('OtherData');
			//时间控件
			mui.ajax({
				url:url,
				type:'post',
				data:{
					msgBody:JSON.stringify({
                   		PatientMRN:MRN,
                    	CurrentTime:new Date().Format("yyyy-MM-dd hh:mm:ss")
                	}),                   
                	msgHeader:JSON.stringify({
                    	ServerName:'GetTimeList',
                    	Format: 'json',
                    	CallOperator: '',
                    	Certificate:'123456'})
				},
				dataType:'json',
				success:function(data){
					var timeArr=[];
					for(var i=0;i<data.Contents.length;i++){
						timeArr.push(data.Contents[i].Time);
					}
					var hour=new Date().getHours();
					var three=document.getElementsByClassName('three')[0];
					var one=document.getElementsByClassName('one')[0];
					var two=document.getElementsByClassName('two')[0];
					//设置时间的默认值为当前时间
					for(var i=0;i<timeArr.length;i++){
						var colonIndex=timeArr[i].indexOf(':');
						var nextIndex=i+1>=timeArr.length-1?timeArr.length-1:i+1;
						if(timeArr[i].substring(0,colonIndex)<=hour && timeArr[nextIndex].substring(0,colonIndex)>hour){					
							two.innerHTML=timeArr[i];
							two.setAttribute('index',i);
							if(i<=0){
								three.innerHTML=timeArr[i+1];
								three.setAttribute('index',i+1);						
								one.innerHTML=timeArr[timeArr.length-1];
								one.setAttribute('index',timeArr.length-1);
								continue;
							}
							if(i>=timeArr.length-1){
								one.innerHTML=timeArr[i-1];
								one.setAttribute('index',i-1);
								three.innerHTML=timeArr[0];
								three.setAttribute('index',0);
								continue;
							}
							one.innerHTML=timeArr[i-1];
							one.setAttribute('index',i-1);
							three.innerHTML=timeArr[i+1];
							three.setAttribute('index',i+1);
						}
					}		
//					查找当前时间的记录
					mui.ajax({
							url:url,
							type:'post',
							data:{
								msgBody:JSON.stringify({
		                   			PatientMRN:MRN,
		                    		OperateTime:new Date().Format('yyyy-MM-dd')+" "+two.innerHTML+":00",
		                    		ColumnID:parseInt(two.getAttribute('index'))+3+''
                				}),                   
                				msgHeader:JSON.stringify({
                    				ServerName:'GetObservationItemLast',
                    				Format: 'json',
                    				CallOperator: '',
                    				Certificate:'123456'})
								},
							dataType:'json',
							success:function(data){
								if(data.Code==0){
									if(parseInt(two.innerHTML.substr(0,2))!=parseInt(data.Contents.OperateTime.substring(data.Contents.OperateTime.indexOf(" "),data.Contents.OperateTime.indexOf(":")))){
										document.getElementsByClassName('listcontainer')[0].classList.remove('hasSave');
										var inputs=document.getElementsByClassName('listcontainer')[0].getElementsByTagName('input');
										for(var i=0;i<inputs.length;i++){
											inputs[i].value='';
										}
										for(var j=0;j<selectors.length;j++){
											selectors[j].value='';
										} 
										return;
									}
									for(var key in data.Contents){
										if(key=='OperateTime'){
											continue;
										}
										document.getElementsByClassName('listcontainer')[0].classList.add('hasSave');
										document.getElementsByName(key)[0].value=data.Contents[key];
										
									}
								}else {
										document.getElementsByClassName('listcontainer')[0].classList.remove('hasSave');
										var inputs=document.getElementsByClassName('listcontainer')[0].getElementsByTagName('input');
										for(var i=0;i<inputs.length;i++){
											inputs[i].value='';
										}
										for(var j=0;j<selectors.length;j++){
											selectors[j].value='';
										} 
								}
							}
						})
					var timeBoxs=document.getElementsByClassName('time')[0].children;
					//设置位置
					for(var i=0;i<timeBoxs.length;i++){
						timeBoxs[i].style.left=170*i/100+'rem';
					}
//					修改时间
					two.addEventListener('tap',function(){
						this.style.display='none';
						this.previousElementSibling.value=this.innerHTML;
						var that=this;
						this.previousElementSibling.addEventListener('change',function(){
							that.innerHTML=this.value;
							 mui.ajax({
								url:url,
								type:'get',
								data:{
									msgBody:JSON.stringify({                   				
		                    			Time:new Date().Format("yyyy-MM-dd")+" "+this.value,
		                    			ColumnID:parseInt(that.getAttribute('index'))+3+'',
		                    			PatientMRN:MRN
		                			}),                   
		                			msgHeader:JSON.stringify({
				                    	ServerName:'UpdateTime',
				                    	Format: 'json',
				                    	CallOperator: '',
				                    	Certificate:'123456'
			                    	})
								},
								dataType:'json',
								success:function(data){
									if(data.Code==0){
										
									}				
								}
							})					
							var changeIndex=that.getAttribute('index');
							timeArr[changeIndex]=that.innerHTML;
							that.style.display='block';
						})		
						this.previousElementSibling.addEventListener('blur',function(){
							console.log(123);
							that.innerHTML=this.value;
							that.style.display='block';
						})
						
					})
//					查询最近的记录
					one.addEventListener('tap',function(){
						if(!this.innerHTML){
							return;
						}
						var thisInnerHtml=this.innerHTML;
						var tapIndex=parseInt(one.getAttribute('index'));
							two.innerHTML=timeArr[tapIndex];
							two.setAttribute('index',tapIndex);
							three.innerHTML=timeArr[tapIndex+1];
							three.setAttribute('index',parseInt(tapIndex+1));
							if(tapIndex<=0){
								one.innerHTML='';
								one.setAttribute('index',0);
							}else {
								one.innerHTML=timeArr[tapIndex-1];
								one.setAttribute('index',tapIndex-1);
							}									
						document.getElementsByClassName('listcontainer')[0].classList.remove('OtherData');
						mui.ajax({
							url:url,
							type:'post',
							data:{
								msgBody:JSON.stringify({
		                   			PatientMRN:MRN,
		                    		OperateTime:new Date().Format('yyyy-MM-dd')+" "+thisInnerHtml+":00",
		                    		ColumnID:parseInt(this.getAttribute('index'))+3+''
                				}),                   
                				msgHeader:JSON.stringify({
                    				ServerName:'GetObservationItemLast',
                    				Format: 'json',
                    				CallOperator: '',
                    				Certificate:'123456'})
								},
							dataType:'json',
							success:function(data){
								if(data.Code==0){
									console.log(parseInt(thisInnerHtml.substr(0,2)));
									console.log(parseInt(data.Contents.OperateTime.substring(data.Contents.OperateTime.indexOf(" "),data.Contents.OperateTime.indexOf(":"))));
									if(parseInt(thisInnerHtml.substr(0,2))!=parseInt(data.Contents.OperateTime.substring(data.Contents.OperateTime.indexOf(" "),data.Contents.OperateTime.indexOf(":")))){
										document.getElementsByClassName('listcontainer')[0].classList.add('OtherData');
									}
									for(var key in data.Contents){
										if(key=='OperateTime'){
											continue;
										}
										document.getElementsByClassName('listcontainer')[0].classList.add('hasSave');
										document.getElementsByName(key)[0].value=data.Contents[key];
										
									}
								}else {
										document.getElementsByClassName('listcontainer')[0].classList.remove('hasSave');
										var inputs=document.getElementsByClassName('listcontainer')[0].getElementsByTagName('input');
										for(var i=0;i<inputs.length;i++){
											inputs[i].value='';
										}
										for(var j=0;j<selectors.length;j++){
											selectors[j].value='';
										} 
								}
							}
						})
					})
//					切换到最新的时间
					three.addEventListener('tap',function(){
//						console.log(parseInt(this.innerHTML.substr(0,2)));
//						console.log(new Date().getHours());
						if(!this.innerHTML){
							return;
						}
						var thisInnerHtml=this.innerHTML;
						var tapIndex=parseInt(three.getAttribute('index'));
								two.innerHTML=timeArr[tapIndex];
								two.setAttribute('index',tapIndex);
								one.innerHTML=timeArr[tapIndex-1];
								one.setAttribute('index',tapIndex-1);
								if(tapIndex>=timeArr.length-1){									
									three.innerHTML="";
									three.setAttribute('index',timeArr.length-1);
								}else {
									three.innerHTML=timeArr[tapIndex+1];
									three.setAttribute('index',parseInt(tapIndex+1));
								}	
						
						mui.ajax({
							url:url,
							type:'post',
							data:{
								msgBody:JSON.stringify({
		                   			PatientMRN:MRN,
		                    		OperateTime:new Date().Format('yyyy-MM-dd')+" "+thisInnerHtml+":00",
		                    		ColumnID:parseInt(this.getAttribute('index'))+3+''
                				}),                   
                				msgHeader:JSON.stringify({
                    				ServerName:'GetObservationItemLast',
                    				Format: 'json',
                    				CallOperator: '',
                    				Certificate:'123456'})
								},
							dataType:'json',
							success:function(data){
								if(data.Code==0){
									if(parseInt(thisInnerHtml.substr(0,2))!=parseInt(data.Contents.OperateTime.substring(data.Contents.OperateTime.indexOf(" "),data.Contents.OperateTime.indexOf(":")))){
										document.getElementsByClassName('listcontainer')[0].classList.add('OtherData');
									}
									for(var key in data.Contents){
										if(key=='OperateTime'){
											continue;
										}
										document.getElementsByClassName('listcontainer')[0].classList.add('hasSave');
										document.getElementsByName(key)[0].value=data.Contents[key];									
									}
								}else {
										document.getElementsByClassName('listcontainer')[0].classList.remove('hasSave');
										var inputs=document.getElementsByClassName('listcontainer')[0].getElementsByTagName('input');
										for(var i=0;i<inputs.length;i++){
											inputs[i].value='';
										}
										for(var j=0;j<selectors.length;j++){
											selectors[j].value='';
										} 
								}
							}
						})
					})
//					保存并上传数据
					document.getElementById('saveBtn').addEventListener('tap',function(e){
						var saveObj={
						PatientMRN:MRN,
						PatientNumber: patientNumber,
						PatientName:patientName,
						ColumnId:parseInt(two.getAttribute('index'))+3+'',
						OperateTime:new Date().Format('yyyy-MM-dd')+" "+two.innerHTML+":00"
						};
						var inputs=document.getElementsByClassName('listcontainer')[0].getElementsByTagName('input');
						for(var i=0;i<inputs.length;i++){
							var nameInputAttr=inputs[i].getAttribute('name');
							saveObj[nameInputAttr]=inputs[i].value;
						}
						for(var j=0;j<selectors.length;j++){
							var nameSelectAttr=selectors[j].getAttribute('name');
							saveObj[nameSelectAttr]=selectors[j].value;
						} 
						mui.ajax({
							url:url,
							type:'post',
							data:{
								msgBody:JSON.stringify(saveObj),                   
		                		msgHeader:JSON.stringify({
		                    	ServerName:'SaveObservationItem',
		                    	Format: 'json',
		                    	CallOperator: '',
		                    	Certificate:'123456'})
							},
							dataType:'json',
							success:function(data){
								console.log(data);
								if(data.Code==0){
									document.getElementsByClassName('listcontainer')[0].classList.add('hasSave');
									document.getElementsByClassName('listcontainer')[0].classList.remove('OtherData');
								}
							}
						})
					});

				}
			})			
							
			getObservation('OxygenDom','血氧位置','Oxygen','OxygenTpl');
			getObservation('faceDom','面色/肢端','face','faceTpl');
			getObservation('skinDom','皮肤','skin','skinTpl');
			getObservation('muscleDom','肌张力','skin','skinTpl');
			getObservation('stomachDom','腹部','stomach','stomachTpl');
			getObservation('bodyDom','体位','body','bodyTpl');
			getObservation('oxygenTherapyDom','氧疗方式','oxygenTherapy','oxygenTherapyTpl');
			getObservation('SecretionDom','口鼻腔分泌物','Secretion','SecretionTpl');
			getObservation('modelDom','模式','model','modelTpl');
			getObservation('PIPDom','PIP/PEEP','PIP','PIPTpl');
			getObservation('tracheaDom','气管内分泌物','trachea','tracheaTpl');
			function getObservation(id,obserInstance,list,tpl){
				mui.ajax({
					url:url,
					type:'get',
					data:{
						msgBody:JSON.stringify({
		                   			Observation:obserInstance
                				}),                   
                				msgHeader:JSON.stringify({
                    				ServerName:'GetSelectValues',
                    				Format: 'json',
                    				CallOperator: '',
                    				Certificate:'123456'
                    			})
					},
					dataType:'json',
					success:function(data){
						if(data.Code==0){
							var obj={};
							obj[list]=data.Contents;
							var html=template(tpl,obj);
							document.getElementById(id).innerHTML=html;
						}else {
							var obj={};
							data.Contents=[];
							data.Contents[0]='';
							obj[list]=data.Contents;
							var html=template(tpl,obj);
							document.getElementById(id).innerHTML=html;
						}
						
					}
				})
			}
		</script>
		
			
		<!--底部导航切换-->
		<script src="../js/nav_tab.js"></script>	
	</body>

</html>